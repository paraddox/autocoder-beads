# =============================================================================
# Project Container Dockerfile
# =============================================================================
# Minimal container for running Claude Code on a single project.
# No Python backend, no MCP servers - just Claude Code + beads CLI.
#
# Usage:
#   docker build -f Dockerfile.project -t autocoder-project .
#   docker run -d --name autocoder-{project} -v /path/to/project:/project autocoder-project

FROM ubuntu:24.04

# Prevent interactive prompts
ENV DEBIAN_FRONTEND=noninteractive

# Disable beads daemon in containers (avoids stale lock file issues)
ENV BD_NO_DAEMON=true

# Install essentials
RUN apt-get update && apt-get install -y \
    git \
    curl \
    wget \
    ca-certificates \
    nodejs \
    npm \
    sudo \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user (required for Claude Code --dangerously-skip-permissions)
# Use a different UID to avoid conflicts with existing ubuntu user
# The coder user has passwordless sudo for installing packages
RUN useradd --uid 1001 -m coder \
    && echo "coder ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Install Claude Code CLI globally
RUN npm install -g @anthropic-ai/claude-code

# Install beads CLI
RUN curl -fsSL https://raw.githubusercontent.com/steveyegge/beads/main/scripts/install.sh | bash \
    && mv /root/.local/bin/bd /usr/local/bin/bd 2>/dev/null || true

# Configure git for beads operations (for root, during build)
RUN git config --global user.email "docker@autocoder.local" \
    && git config --global user.name "AutoCoder Docker" \
    && git config --global init.defaultBranch main

# Create directories for coder user
RUN mkdir -p /home/coder/.claude \
    && chown -R coder:coder /home/coder

# Configure git for coder user and set permissive umask
USER coder
RUN git config --global user.email "docker@autocoder.local" \
    && git config --global user.name "AutoCoder Docker" \
    && git config --global init.defaultBranch main \
    && echo "umask 002" >> ~/.bashrc \
    && echo "umask 002" >> ~/.profile

# Switch back to root for runtime volume mounting
USER root

# Working directory is the mounted project
WORKDIR /project

# Create entrypoint script to copy credentials at startup
RUN cat > /entrypoint.sh << 'EOF'
#!/bin/bash
# Set permissive umask so files are readable by host user
# 002 = files 664, dirs 775 (group and world readable)
umask 002

# Update Claude Code to latest version at startup
echo "Updating Claude Code to latest version..."
npm update -g @anthropic-ai/claude-code 2>/dev/null || true

# Copy Claude credentials from mounted location (if exists)
# Use shopt to enable dotglob for copying hidden files like .credentials.json
if [ -d "/tmp/claude-creds" ]; then
    shopt -s dotglob
    cp -r /tmp/claude-creds/* /home/coder/.claude/ 2>/dev/null || true
    shopt -u dotglob
    chown -R coder:coder /home/coder/.claude
fi

# Clean up stale beads daemon lock files (prevents stack overflow bug)
if [ -f "/project/.beads/daemon.lock" ]; then
    rm -f /project/.beads/daemon.lock
    echo "Removed stale beads daemon.lock"
fi

# Fix .beads directory permissions (allow container to write, host to read)
if [ -d "/project/.beads" ]; then
    # Make all files writable by container user
    chown -R coder:coder /project/.beads 2>/dev/null || true
    chmod -R a+rw /project/.beads 2>/dev/null || true
fi

# Keep container running
exec tail -f /dev/null
EOF
RUN chmod +x /entrypoint.sh

# Default command - entrypoint copies creds then keeps container alive
CMD ["/entrypoint.sh"]
